<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoSpec Hub ¬∑ Hojalater√≠a (US & PR)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF + AutoTable (PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg: #0b0d12; --panel:#12151d; --panel-2:#171b25; --text:#e5e7eb; --muted:#9aa3b2; --primary:#7c5cff; --primary-2:#5b39ff; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --border:#242a36; --shadow:0 8px 24px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:radial-gradient(1200px 800px at 80% -10%, #1b2030 0%, #0b0d12 40%, #0b0d12 100%); color:var(--text)}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    .card{background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .hd{padding:28px 28px 0; display:flex; align-items:center; gap:12px}
    .badge{font-size:12px; color:#cfd5e3; background:#222836; border:1px solid #2a3040; padding:4px 8px; border-radius:999px}
    .title{font-size:24px; font-weight:700; letter-spacing:.2px}
    .subtitle{font-size:14px; color:var(--muted); margin-top:4px}
    .card .bd{padding:24px 28px 28px}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width:860px){.grid-2,.grid-3{grid-template-columns:1fr}}
    .input{width:100%; background:#0f131b; border:1px solid #202536; color:var(--text); padding:12px; border-radius:12px; outline:none; transition:border .2s ease}
    .input:focus{border-color:var(--primary)}
    .btn{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:600; background:var(--primary); color:white; box-shadow:0 6px 16px rgba(124,92,255,.35); transition:transform .05s ease, background .2s ease}
    .btn:hover{background:var(--primary-2)} .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none}
    .btn.warn{background:var(--warning); color:#0f0f11; box-shadow:0 6px 16px rgba(245,158,11,.35)}
    .btn.success{background:var(--success); color:#07110e}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .toolbar .spacer{flex:1}
    .kpis{display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-top:12px}
    .kpi{background:#0e121a; border:1px solid #202536; padding:16px; border-radius:14px}
    .kpi .label{font-size:12px; color:var(--muted)} .kpi .value{font-size:20px; font-weight:700; margin-top:6px}
    table{width:100%; border-collapse:collapse}
    thead th{text-align:left; font-size:12px; color:#b5bed1; padding:10px; border-bottom:1px solid #232a3a; position:sticky; top:0; background:#111522}
    tbody td{padding:12px 10px; border-bottom:1px solid #1a2030; font-size:14px}
    tbody tr:hover{background:#0f1320}
    .table-wrap{overflow:auto; max-height:480px; border:1px solid #1c2232; border-radius:12px}
    .pill{padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #273149; background:#121a2d}
    .footer{margin:26px 0; color:var(--muted); font-size:12px; text-align:center}
    .hidden{display:none !important} .right{text-align:right}
    .tag{background:#0c111b; border:1px solid #20283a; color:#b6c1d6; font-size:11px; padding:4px 8px; border-radius:999px}
    .note{font-size:12px; color:#9aa3b2}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px; background:linear-gradient(90deg, #c8d4ff, #9daaff, #c9bfff); -webkit-background-clip:text; background-clip:text; color:transparent}
    .logo svg{width:22px; height:22px}
    .brandbox{display:flex; align-items:center; gap:10px}
    .brandbox img{height:28px; width:auto; border-radius:6px; border:1px solid #20283a}
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(6,9,14,.6); backdrop-filter:blur(4px); z-index:50}
    .modal-card{width:min(740px,94vw); background:linear-gradient(180deg, #111622, #0f1420); border:1px solid #232b3f; border-radius:16px; box-shadow:var(--shadow)}
    .modal .hd,.modal .bd{padding:18px 18px 0} .modal .bd{padding-bottom:18px}
  </style>
</head>
<body>
  <div class="container">
    <!-- ========== AUTH ========= -->
    <div id="authCard" class="card">
      <div class="hd">
        <div class="brandbox">
          <img id="brandLogo" src="" alt="logo" class="hidden"/>
          <div class="logo">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 12a8 8 0 1 1 16 0v3a3 3 0 0 0 3 3H1a3 3 0 0 0 3-3v-3Z" stroke="#8ea2ff" stroke-width="1.2"/><path d="M9.5 9.5h5v5h-5z" stroke="#b9c4ff" stroke-width="1.2"/></svg>
            <span id="appName">AutoSpec Hub</span>
          </div>
        </div>
        <span class="badge">US & Puerto Rico</span>
      </div>
      <div class="bd">
        <div class="grid-2">
          <div>
            <div class="title">Inicia sesi√≥n</div>
            <div class="subtitle">Hojalater√≠a: dimensiones, espesores, materiales y tiempos.</div>
            <div style="height:8px"></div>
            <label>Correo</label>
            <input id="authEmail" class="input" type="email" placeholder="taller@ejemplo.com" />
            <label style="margin-top:10px; display:block;">Contrase√±a</label>
            <input id="authPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px; gap:10px;">
              <button class="btn" onclick="Auth.login()">Entrar</button>
              <button class="btn ghost" onclick="Auth.register()">Crear cuenta</button>
              <div class="note">Local (demo con localStorage)</div>
            </div>
          </div>
          <div>
            <div class="kpis">
              <div class="kpi"><div class="label">Registros</div><div id="kpiRecords" class="value">0</div></div>
              <div class="kpi"><div class="label">Marcas</div><div id="kpiBrands" class="value">0</div></div>
              <div class="kpi"><div class="label">Modelos</div><div id="kpiModels" class="value">0</div></div>
              <div class="kpi"><div class="label">A√±os</div><div id="kpiYears" class="value">0</div></div>
              <div class="kpi"><div class="label">Espesor prom. (mm)</div><div id="kpiThk" class="value">‚Äî</div></div>
            </div>
            <div style="margin-top:12px" class="note">Configura logo y nombre en ‚öôÔ∏è Ajustes (dentro de la app).</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== APP ========= -->
    <div id="app" class="card hidden" style="margin-top:18px;">
      <div class="hd" style="justify-content:space-between; gap:12px;">
        <div class="brandbox">
          <img id="brandLogo2" src="" alt="logo" class="hidden"/>
          <div class="logo"><span id="appName2">AutoSpec Hub</span></div>
          <span class="badge">US & PR</span>
        </div>
        <div class="toolbar">
          <span class="tag" id="userEmailTag">‚Äî</span>
          <button class="btn ghost" onclick="UI.openSettings()">‚öôÔ∏è Ajustes</button>
          <button class="btn ghost" onclick="UI.toggleDarkMode()"><span id="dmLabel">Oscuro</span></button>
          <button class="btn ghost" onclick="Auth.logout()">Salir</button>
        </div>
      </div>
      <div class="bd">
        <div class="toolbar" style="gap:12px;">
          <input id="q" class="input" style="max-width:280px" placeholder="Buscar (marca, modelo, a√±o, panel, material)" oninput="UI.applyFilters()" />
          <select id="fBrand" class="input" onchange="UI.syncModels(); UI.applyFilters()"><option value="">Marca</option></select>
          <select id="fModel" class="input" onchange="UI.applyFilters()"><option value="">Modelo</option></select>
          <select id="fYear" class="input" onchange="UI.applyFilters()"><option value="">A√±o</option></select>
          <select id="fMarket" class="input" onchange="UI.applyFilters()"><option value="">Mercado</option><option>US</option><option>PR</option></select>
          <select id="fMaterial" class="input" onchange="UI.applyFilters()"><option value="">Material</option><option>Acero</option><option>Aluminio</option><option>Pl√°stico</option></select>
          <select id="fPanel" class="input" onchange="UI.applyFilters()"><option value="">Panel</option></select>
          <div class="spacer"></div>
          <label class="btn ghost" for="jsonFile">‚ûï Importar JSON</label>
          <input id="jsonFile" type="file" accept="application/json" class="hidden" />
          <button class="btn ghost" onclick="Export.toJSON()">Exportar JSON</button>
          <button class="btn" onclick="Export.toPDF()">Exportar PDF</button>
          <button class="btn warn" onclick="UI.openAddModal()">Nuevo registro</button>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="label">En tabla</div><div id="kpiVisible" class="value">0</div></div>
          <div class="kpi"><div class="label">Espesor prom. (mm)</div><div id="kpiThk2" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Body hrs prom.</div><div id="kpiBody" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Refinish hrs prom.</div><div id="kpiRef" class="value">‚Äî</div></div>
          <div class="kpi"><div class="label">Material m√°s com√∫n</div><div id="kpiMat" class="value">‚Äî</div></div>
        </div>

        <div class="table-wrap" style="margin-top:14px;">
          <table id="tbl">
            <thead>
              <tr>
                <th>Marca</th><th>Modelo</th><th>A√±o</th><th>Mercado</th>
                <th>Panel</th><th>Lado</th><th>Material</th>
                <th class="right">Espesor (mm)</th><th class="right">¬± (mm)</th>
                <th>Zona</th>
                <th class="right">Largo (mm)</th><th class="right">Ancho (mm)</th><th class="right">Alto (mm)</th><th class="right">Dist. ejes (mm)</th>
                <th class="right">Body Hrs</th><th class="right">Refinish Hrs</th>
                <th>Adhesivo</th><th>Sealer</th><th>Sujetadores</th><th class="right">Torque (Nm)</th>
                <th>Paint</th><th>Blend</th><th>OEM</th>
                <th class="right">Peso (kg)</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer">üíæ Todo se guarda en tu navegador. Importa JSON a gran escala y exporta tu vista a PDF o JSON.</div>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo registro -->
  <div id="addModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="hd" style="display:flex; align-items:center; justify-content:space-between;">
        <div class="title">A√±adir registro (Hojalater√≠a)</div>
        <button class="btn ghost" onclick="UI.closeAddModal()">Cerrar</button>
      </div>
      <div class="bd">
        <div class="grid-3">
          <input id="newBrand" class="input" placeholder="Marca" />
          <input id="newModel" class="input" placeholder="Modelo" />
          <input id="newYear" class="input" type="number" placeholder="A√±o" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <select id="newMarket" class="input"><option>US</option><option>PR</option></select>
          <input id="newPanel" class="input" placeholder="Panel (ej. Puerta delantera)" />
          <input id="newSide" class="input" placeholder="Lado (LH/RH)" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newMaterial" class="input" placeholder="Material (Acero/Aluminio/Pl√°stico)" />
          <input id="newThk" class="input" type="number" step="0.1" placeholder="Espesor (mm)" />
          <input id="newTol" class="input" type="number" step="0.1" placeholder="Tolerancia (¬±mm)" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newZone" class="input" placeholder="Zona de reparaci√≥n (A/B/C)" />
          <input id="newWhl" class="input" type="number" placeholder="Dist. ejes (mm)" />
          <input id="newWgt" class="input" type="number" placeholder="Peso (kg)" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newLen" class="input" type="number" placeholder="Largo (mm)" />
          <input id="newWid" class="input" type="number" placeholder="Ancho (mm)" />
          <input id="newHei" class="input" type="number" placeholder="Alto (mm)" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newBodyHr" class="input" type="number" step="0.1" placeholder="Body hours" />
          <input id="newRefHr" class="input" type="number" step="0.1" placeholder="Refinish hours" />
          <input id="newPaint" class="input" placeholder="C√≥digo de pintura" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newFast" class="input" placeholder="Sujetadores (tornillos/remaches)" />
          <input id="newTorque" class="input" type="number" step="0.1" placeholder="Torque (Nm)" />
          <input id="newAdh" class="input" placeholder="Adhesivo (epoxi/panel bonding)" />
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newSealer" class="input" placeholder="Seam sealer" />
          <input id="newOEM" class="input" placeholder="URL procedimiento OEM" />
          <select id="newBlend" class="input"><option value="true">Requiere mezcla</option><option value="false">Sin mezcla</option></select>
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <input id="newNotes" class="input" placeholder="Notas" />
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button class="btn ghost" onclick="UI.closeAddModal()">Cancelar</button>
          <button class="btn success" onclick="Data.addFromForm()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ajustes -->
  <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="hd" style="display:flex; align-items:center; justify-content:space-between;">
        <div class="title">Ajustes</div>
        <button class="btn ghost" onclick="UI.closeSettings()">Cerrar</button>
      </div>
      <div class="bd">
        <div class="grid-3">
          <div>
            <label>Nombre de la app</label>
            <input id="setName" class="input" placeholder="AutoSpec Hub" />
          </div>
          <div>
            <label>Logo (PNG/JPG)</label>
            <input id="setLogo" type="file" accept="image/*" class="input" />
          </div>
          <div>
            <label>Color primario</label>
            <input id="setPrimary" class="input" type="color" value="#7c5cff" />
          </div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button class="btn success" onclick="UI.saveSettings()">Guardar ajustes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Claves LS
    const LS_KEYS = { USERS:'ash_users', SESSION:'ash_session', DATA:'ash_data', SETTINGS:'ash_settings' };

    // ===== Datos demo orientados a hojalater√≠a
    const seed = [
      { brand:'Toyota', model:'Camry', year:2024, market:'US', panel:'Puerta delantera', side:'LH', material:'Acero', thickness_mm:0.8, tolerance_mm:0.3, repair_zone:'Zona A', length_mm:4910, width_mm:1840, height_mm:1445, wheelbase_mm:2825, curb_kg:1490, labor_body_hr:2.5, labor_refinish_hr:1.6, seam_sealer:'PU', adhesive:'Epoxi', fasteners:'Clips+tornillos', torque_nm:7, oem_proc_url:'', paint_code:'1G3', blend_required:true, notes:'Desmontaje moldura.' },
      { brand:'Toyota', model:'Corolla', year:2024, market:'PR', panel:'Guardafangos', side:'RH', material:'Acero', thickness_mm:0.7, tolerance_mm:0.3, repair_zone:'Zona B', length_mm:4630, width_mm:1780, height_mm:1435, wheelbase_mm:2700, curb_kg:1310, labor_body_hr:3.2, labor_refinish_hr:2.0, seam_sealer:'-', adhesive:'-', fasteners:'Tornillos', torque_nm:9, oem_proc_url:'', paint_code:'218', blend_required:false, notes:'' },
      { brand:'Honda', model:'Civic', year:2023, market:'US', panel:'Bonete', side:'-', material:'Aluminio', thickness_mm:1.0, tolerance_mm:0.2, repair_zone:'Zona A', length_mm:4670, width_mm:1800, height_mm:1415, wheelbase_mm:2735, curb_kg:1250, labor_body_hr:2.0, labor_refinish_hr:2.2, seam_sealer:'-', adhesive:'Epoxi', fasteners:'Pernos', torque_nm:22, oem_proc_url:'', paint_code:'NH-883P', blend_required:true, notes:'Cuidado con disipadores.' }
    ];

    // ===== Utilidades
    const Utils = {
      loadLS(k, fb){ try{ return JSON.parse(localStorage.getItem(k)) ?? fb; }catch(e){ return fb; } },
      saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      uid(){ return Math.random().toString(36).slice(2,9); },
      normalize(record){
        const r = { ...record };
        r.brand = r.brand || r.marca || r.make || r.Make;
        r.model = r.model || r.modelo || r.Model || r.name;
        r.year = Number(r.year || r.ano || r.Ano || r.Year);
        r.market = (r.market || r.mercado || r.Market || 'US').toUpperCase();
        r.panel = r.panel || r.pieza || r.componente || r.panel_name;
        r.side = r.side || r.lado || r.Side || '-';
        r.material = r.material || r.material_type || r.mat;
        const toMM = (v, unit) => { if(v==null||v==='') return undefined; const n=Number(v); if(Number.isNaN(n)) return undefined; if(!unit) return n; const u=String(unit).toLowerCase(); return (u.includes('in'))? Math.round(n*25.4): n; };
        r.thickness_mm = Number(r.thickness_mm ?? r.espesor_mm ?? (r.thickness_in ? Math.round(Number(r.thickness_in)*25.4)/10 : undefined) ?? r.gauge_mm);
        r.tolerance_mm = Number(r.tolerance_mm ?? r.tolerancia_mm ?? r.tol_mm);
        r.repair_zone = r.repair_zone || r.zona || r.repair_area;
        r.length_mm = r.length_mm ?? r.largo_mm ?? toMM(r.length_in || r.largo_in,'in') ?? toMM(r.length, r.length_unit);
        r.width_mm  = r.width_mm  ?? r.ancho_mm ?? toMM(r.width_in  || r.ancho_in ,'in') ?? toMM(r.width, r.width_unit);
        r.height_mm = r.height_mm ?? r.alto_mm  ?? toMM(r.height_in || r.alto_in ,'in') ?? toMM(r.height, r.height_unit);
        r.wheelbase_mm = r.wheelbase_mm ?? r.dist_ejes_mm ?? toMM(r.wheelbase_in || r.dist_ejes_in,'in') ?? toMM(r.wheelbase, r.wheelbase_unit);
        r.curb_kg = r.curb_kg ?? r.peso_kg ?? (r.curb_lb ? Math.round(Number(r.curb_lb)*0.453592) : undefined) ?? r.weight_kg;
        r.labor_body_hr = Number(r.labor_body_hr ?? r.body_hours ?? r.horas_hojalateria);
        r.labor_refinish_hr = Number(r.labor_refinish_hr ?? r.refinish_hours ?? r.horas_pintura);
        r.fasteners = r.fasteners || r.sujetadores || r.fijaciones;
        r.torque_nm = Number(r.torque_nm ?? r.torque_Nm ?? r.torque);
        r.seam_sealer = r.seam_sealer || r.sella_juntas || r.sello_juntas;
        r.adhesive = r.adhesive || r.adhesivo || r.panel_bond;
        r.paint_code = r.paint_code || r.codigo_pintura || r.paint;
        r.blend_required = !!(r.blend_required ?? r.mezcla ?? r.blend);
        r.oem_proc_url = r.oem_proc_url || r.oem || r.procedimiento;
        r.notes = r.notes || r.notas;
        if(!r.brand || !r.model || !r.year) return null;
        return { id: r.id || Utils.uid(), brand:String(r.brand).trim(), model:String(r.model).trim(), year:Number(r.year), market:r.market,
          panel:r.panel ?? null, side:r.side ?? null, material:r.material ?? null, thickness_mm:(r.thickness_mm!=null&&!Number.isNaN(Number(r.thickness_mm)))?Number(r.thickness_mm):null,
          tolerance_mm:(r.tolerance_mm!=null&&!Number.isNaN(Number(r.tolerance_mm)))?Number(r.tolerance_mm):null, repair_zone:r.repair_zone ?? null,
          length_mm:Number(r.length_mm)||null, width_mm:Number(r.width_mm)||null, height_mm:Number(r.height_mm)||null, wheelbase_mm:Number(r.wheelbase_mm)||null, curb_kg:Number(r.curb_kg)||null,
          labor_body_hr:(r.labor_body_hr!=null&&!Number.isNaN(Number(r.labor_body_hr)))?Number(r.labor_body_hr):null,
          labor_refinish_hr:(r.labor_refinish_hr!=null&&!Number.isNaN(Number(r.labor_refinish_hr)))?Number(r.labor_refinish_hr):null,
          fasteners:r.fasteners ?? null, torque_nm:(r.torque_nm!=null&&!Number.isNaN(Number(r.torque_nm)))?Number(r.torque_nm):null,
          seam_sealer:r.seam_sealer ?? null, adhesive:r.adhesive ?? null, paint_code:r.paint_code ?? null, blend_required:!!r.blend_required,
          oem_proc_url:r.oem_proc_url ?? null, notes:r.notes ?? null };
      },
      groupBy(arr, key){ return arr.reduce((m, it) => ((m[it[key]] = m[it[key]] || []).push(it), m), {}); },
      avg(arr){ if(!arr.length) return null; const s = arr.reduce((a,b)=>a+b,0); return Math.round(s/arr.length*10)/10; },
      download(filename, text){ const el=document.createElement('a'); el.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); el.download=filename; el.style.display='none'; document.body.appendChild(el); el.click(); document.body.removeChild(el); }
    };

    // ===== Auth (demo local)
    const Auth = {
      users: Utils.loadLS(LS_KEYS.USERS, []),
      session: Utils.loadLS(LS_KEYS.SESSION, null),
      login(){ const email = document.getElementById('authEmail').value.trim().toLowerCase(); const pass = document.getElementById('authPass').value; const u=this.users.find(x=>x.email===email); if(!u){alert('Usuario no encontrado. Crea una cuenta.'); return;} if(u.pass!==btoa(pass)){alert('Contrase√±a incorrecta.'); return;} this.session={email}; Utils.saveLS(LS_KEYS.SESSION,this.session); UI.enterApp(); },
      register(){ const email=document.getElementById('authEmail').value.trim().toLowerCase(); const pass=document.getElementById('authPass').value; if(!email||!pass){alert('Completa correo y contrase√±a'); return;} if(this.users.some(x=>x.email===email)){alert('Ese correo ya est√° registrado'); return;} this.users.push({email, pass:btoa(pass)}); Utils.saveLS(LS_KEYS.USERS,this.users); alert('Cuenta creada. Ahora inicia sesi√≥n.'); },
      logout(){ this.session=null; localStorage.removeItem(LS_KEYS.SESSION); location.reload(); }
    };

    // ===== Datos
    const Data = {
      all: Utils.loadLS(LS_KEYS.DATA, null) || seed.map(r=>({...r,id:Utils.uid()})),
      persist(){ Utils.saveLS(LS_KEYS.DATA, this.all); },
      add(rec){ this.all.push(rec); this.persist(); },
      addFromForm(){ const rec = Utils.normalize({ brand:val('newBrand'), model:val('newModel'), year:val('newYear'), market:val('newMarket'), panel:val('newPanel'), side:val('newSide'), material:val('newMaterial'), thickness_mm:val('newThk'), tolerance_mm:val('newTol'), repair_zone:val('newZone'), wheelbase_mm:val('newWhl'), curb_kg:val('newWgt'), length_mm:val('newLen'), width_mm:val('newWid'), height_mm:val('newHei'), labor_body_hr:val('newBodyHr'), labor_refinish_hr:val('newRefHr'), paint_code:val('newPaint'), fasteners:val('newFast'), torque_nm:val('newTorque'), adhesive:val('newAdh'), seam_sealer:val('newSealer'), oem_proc_url:val('newOEM'), blend_required: document.getElementById('newBlend').value==='true', notes:val('newNotes') }); if(!rec){ alert('Datos incompletos'); return; } this.add(rec); UI.closeAddModal(); UI.render(); },
      importJSON(text){ let arr; try{ arr=JSON.parse(text);}catch(e){ alert('JSON inv√°lido'); return;} if(!Array.isArray(arr)) arr=[arr]; let added=0; for(const it of arr){ const n=Utils.normalize(it); if(n){ this.add(n); added++; } } UI.render(); alert(`Importados ${added} registros`); },
      delete(id){ if(confirm('¬øEliminar este registro?')){ this.all = this.all.filter(x=>x.id!==id); this.persist(); UI.render(); } }
    };
    const val = id => document.getElementById(id).value;

    // ===== UI
    const UI = {
      state:{ query:'', brand:'', model:'', year:'', market:'', material:'', panel:'' },
      enterApp(){ document.getElementById('authCard').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.getElementById('userEmailTag').textContent = Auth.session?.email || '‚Äî'; this.applySettings(); this.render(); },
      render(){ this.fillFilters(); this.applyFilters();
        document.getElementById('kpiRecords').textContent = Data.all.length;
        document.getElementById('kpiBrands').textContent = Object.keys(Utils.groupBy(Data.all,'brand')).length;
        document.getElementById('kpiModels').textContent = Object.keys(Utils.groupBy(Data.all,'model')).length;
        document.getElementById('kpiYears').textContent = Object.keys(Utils.groupBy(Data.all,'year')).length;
        const thks = Data.all.map(r=>r.thickness_mm).filter(v=>v!=null);
        document.getElementById('kpiThk').textContent = thks.length? Utils.avg(thks): '‚Äî';
      },
      fillFilters(){
        const brands=[...new Set(Data.all.map(x=>x.brand))].sort();
        const years=[...new Set(Data.all.map(x=>x.year))].sort((a,b)=>b-a);
        const panels=[...new Set(Data.all.map(x=>x.panel).filter(Boolean))].sort();
        el('fBrand').innerHTML = '<option value="">Marca</option>'+brands.map(b=>`<option>${b}</option>`).join('');
        el('fYear').innerHTML = '<option value="">A√±o</option>'+years.map(y=>`<option>${y}</option>`).join('');
        el('fPanel').innerHTML = '<option value="">Panel</option>'+panels.map(p=>`<option>${p}</option>`).join('');
        this.syncModels();
      },
      syncModels(){ const brand=el('fBrand').value; const models=[...new Set(Data.all.filter(x=>!brand||x.brand===brand).map(x=>x.model))].sort(); el('fModel').innerHTML='<option value="">Modelo</option>'+models.map(m=>`<option>${m}</option>`).join(''); },
      applyFilters(){ this.state.query=el('q').value.toLowerCase(); this.state.brand=el('fBrand').value; this.state.model=el('fModel').value; this.state.year=el('fYear').value; this.state.market=el('fMarket').value; this.state.material=el('fMaterial').value; this.state.panel=el('fPanel').value;
        const rows = Data.all.filter(r=>{ const txt = `${r.brand} ${r.model} ${r.year} ${r.market} ${r.panel} ${r.material}`.toLowerCase(); const matchQ=!this.state.query||txt.includes(this.state.query); const matchB=!this.state.brand||r.brand===this.state.brand; const matchM=!this.state.model||r.model===this.state.model; const matchY=!this.state.year||String(r.year)===String(this.state.year); const matchMk=!this.state.market||r.market===this.state.market; const matchMat=!this.state.material||r.material===this.state.material; const matchPanel=!this.state.panel||r.panel===this.state.panel; return matchQ&&matchB&&matchM&&matchY&&matchMk&&matchMat&&matchPanel; });
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = rows.map(r=>`
          <tr>
            <td>${r.brand}</td>
            <td>${r.model}</td>
            <td>${r.year}</td>
            <td><span class="pill">${r.market}</span></td>
            <td>${r.panel??'‚Äî'}</td>
            <td>${r.side??'‚Äî'}</td>
            <td>${r.material??'‚Äî'}</td>
            <td class="right">${fmt(r.thickness_mm)}</td>
            <td class="right">${fmt(r.tolerance_mm)}</td>
            <td>${r.repair_zone??'‚Äî'}</td>
            <td class="right">${fmt(r.length_mm,0)}</td>
            <td class="right">${fmt(r.width_mm,0)}</td>
            <td class="right">${fmt(r.height_mm,0)}</td>
            <td class="right">${fmt(r.wheelbase_mm,0)}</td>
            <td class="right">${fmt(r.labor_body_hr)}</td>
            <td class="right">${fmt(r.labor_refinish_hr)}</td>
            <td>${r.adhesive??'‚Äî'}</td>
            <td>${r.seam_sealer??'‚Äî'}</td>
            <td>${r.fasteners??'‚Äî'}</td>
            <td class="right">${fmt(r.torque_nm)}</td>
            <td>${r.paint_code??'‚Äî'}</td>
            <td>${r.blend_required? 'S√≠':'No'}</td>
            <td>${r.oem_proc_url? `<a href="${r.oem_proc_url}" target="_blank">Ver</a>`:'‚Äî'}</td>
            <td class="right">${fmt(r.curb_kg,0)}</td>
            <td class="right">
              <button class="btn ghost" onclick="UI.showDetails('${r.id}')">Ver</button>
              <button class="btn ghost" onclick="Data.delete('${r.id}')">üóë</button>
            </td>
          </tr>`).join('');
        // KPIs
        el('kpiVisible').textContent = rows.length;
        const th = rows.map(r=>r.thickness_mm).filter(x=>x!=null); el('kpiThk2').textContent = th.length? Utils.avg(th):'‚Äî';
        const bh = rows.map(r=>r.labor_body_hr).filter(x=>x!=null); el('kpiBody').textContent = bh.length? Utils.avg(bh):'‚Äî';
        const rh = rows.map(r=>r.labor_refinish_hr).filter(x=>x!=null); el('kpiRef').textContent = rh.length? Utils.avg(rh):'‚Äî';
        const mat = mode(rows.map(r=>r.material).filter(Boolean)); el('kpiMat').textContent = mat || '‚Äî';
      },
      showDetails(id){ const r=Data.all.find(x=>x.id===id); if(!r) return; const lines=[['Marca',r.brand],['Modelo',r.model],['A√±o',r.year],['Mercado',r.market],['Panel',r.panel??'‚Äî'],['Lado',r.side??'‚Äî'],['Material',r.material??'‚Äî'],['Espesor (mm)',fmt(r.thickness_mm)],['Tolerancia (mm)',fmt(r.tolerance_mm)],['Zona',r.repair_zone??'‚Äî'],['Largo (mm)',fmt(r.length_mm,0)],['Ancho (mm)',fmt(r.width_mm,0)],['Alto (mm)',fmt(r.height_mm,0)],['Distancia entre ejes (mm)',fmt(r.wheelbase_mm,0)],['Peso (kg)',fmt(r.curb_kg,0)],['Body hrs',fmt(r.labor_body_hr)],['Refinish hrs',fmt(r.labor_refinish_hr)],['Adhesivo',r.adhesive??'‚Äî'],['Sealer',r.seam_sealer??'‚Äî'],['Sujetadores',r.fasteners??'‚Äî'],['Torque (Nm)',fmt(r.torque_nm)],['Pintura',r.paint_code??'‚Äî'],['Mezcla',r.blend_required?'S√≠':'No'],['OEM', r.oem_proc_url? r.oem_proc_url:'‚Äî'],['Notas',r.notes??'‚Äî']];
        const html = `<div class="modal" onclick="if(event.target===this) this.classList.add('hidden')"><div class="modal-card"><div class="hd" style="display:flex; align-items:center; justify-content:space-between;"><div class="title">${r.brand} ${r.model} ¬∑ ${r.year}</div><button class="btn ghost" onclick="UI.closeTopModal()">Cerrar</button></div><div class="bd">${lines.map(([k,v])=>`<div style='display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #232b3f;'><div class='note'>${k}</div><div><b>${v}</b></div></div>`).join('')}</div></div></div>`;
        const m=document.createElement('div'); m.innerHTML=html.trim(); document.body.appendChild(m.firstChild); },
      closeTopModal(){ const modals=document.querySelectorAll('.modal'); if(modals.length){ modals[modals.length-1].remove(); } },
      openAddModal(){ document.getElementById('addModal').classList.remove('hidden'); },
      closeAddModal(){ document.getElementById('addModal').classList.add('hidden'); },
      toggleDarkMode(){ const body=document.body; body.dataset.theme = body.dataset.theme==='light'? 'dark':'light'; el('dmLabel').textContent = body.dataset.theme==='light'? 'Claro':'Oscuro'; if(body.dataset.theme==='light'){ setThemeLight(); } else { setThemeDark(); } },
      openSettings(){ document.getElementById('settingsModal').classList.remove('hidden'); const s=Settings.get(); el('setName').value=s.name||'AutoSpec Hub'; el('setPrimary').value=s.primary||'#7c5cff'; },
      closeSettings(){ document.getElementById('settingsModal').classList.add('hidden'); },
      saveSettings(){ const s=Settings.get(); s.name=el('setName').value||'AutoSpec Hub'; s.primary=el('setPrimary').value||'#7c5cff'; const file= document.getElementById('setLogo').files?.[0]; if(file){ const fr=new FileReader(); fr.onload=()=>{ s.logo=fr.result; Settings.set(s); UI.applySettings(); UI.closeSettings(); }; fr.readAsDataURL(file); } else { Settings.set(s); UI.applySettings(); UI.closeSettings(); } },
      applySettings(){ const s=Settings.get(); document.getElementById('appName').textContent=s.name||'AutoSpec Hub'; document.getElementById('appName2').textContent=s.name||'AutoSpec Hub'; if(s.logo){ setLogo('brandLogo', s.logo); setLogo('brandLogo2', s.logo); } if(s.primary){ document.documentElement.style.setProperty('--primary', s.primary); } }
    };

    // ===== Settings
    const Settings = { get(){ return Utils.loadLS(LS_KEYS.SETTINGS, {}); }, set(v){ Utils.saveLS(LS_KEYS.SETTINGS, v); } };

    // ===== Export
    const Export = {
      toPDF(){ const { jsPDF } = window.jspdf; const doc=new jsPDF({orientation:'landscape', unit:'pt', format:'a3'}); const rows=[...document.querySelectorAll('#tbl tbody tr')].map(tr=>[...tr.children].slice(0,23).map(td=>td.innerText)); const head=[[ 'Marca','Modelo','A√±o','Mercado','Panel','Lado','Material','Espesor','¬±','Zona','Largo','Ancho','Alto','Dist. ejes','Body','Refinish','Adhesivo','Sealer','Sujetadores','Torque','Paint','Blend','OEM' ]]; doc.setFont('helvetica','bold'); doc.text((Settings.get().name||'AutoSpec Hub')+' ‚Äî Hojalater√≠a',40,40); doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(new Date().toLocaleString(),40,58); doc.autoTable({ startY:76, head, body:rows, styles:{fontSize:9}, headStyles:{fillColor:[124,92,255]} }); doc.save('autospec-hojalateria.pdf'); },
      toJSON(){ const json = JSON.stringify(Data.all, null, 2); Utils.download('autospec-data.json', json); }
    };

    // ===== Helpers DOM/tema/estad√≠stica
    const el = id => document.getElementById(id);
    const fmt = (v, digits=1) => (v==null||Number.isNaN(Number(v)))? '‚Äî' : (typeof v==='number'? v: Number(v)).toFixed(digits);
    const mode = (arr) => { if(!arr.length) return null; const m=new Map(); arr.forEach(x=>m.set(x,(m.get(x)||0)+1)); let best=null, c=0; m.forEach((v,k)=>{ if(v>c){c=v; best=k;} }); return best; };
    function setLogo(id, src){ const img=el(id); img.src=src; img.classList.remove('hidden'); }
    function setThemeLight(){ document.documentElement.style.setProperty('--bg','#f4f6fb'); document.documentElement.style.setProperty('--panel','#ffffff'); document.documentElement.style.setProperty('--panel-2','#f8fafc'); document.documentElement.style.setProperty('--text','#0b1220'); document.documentElement.style.setProperty('--muted','#51607a'); document.documentElement.style.setProperty('--border','#e6eaf3'); document.body.style.background='linear-gradient(180deg, #eef2ff, #f8fafc)'; }
    function setThemeDark(){ document.documentElement.style.setProperty('--bg','#0b0d12'); document.documentElement.style.setProperty('--panel','#12151d'); document.documentElement.style.setProperty('--panel-2','#171b25'); document.documentElement.style.setProperty('--text','#e5e7eb'); document.documentElement.style.setProperty('--muted','#9aa3b2'); document.documentElement.style.setProperty('--border','#242a36'); document.body.style.background='radial-gradient(1200px 800px at 80% -10%, #1b2030 0%, #0b0d12 40%, #0b0d12 100%)'; }

    // ===== Boot
    (function boot(){
      // Cargar ajustes (logo/nombre/color) en login
      UI.applySettings();
      const logo = Settings.get().logo; if(logo){ setLogo('brandLogo', logo); }
      // Auto-login si hay sesi√≥n
      if(Auth.session){ UI.enterApp(); }
      // Input archivo JSON
      document.getElementById('jsonFile').addEventListener('change', (ev)=>{ const file=ev.target.files?.[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>Data.importJSON(reader.result); reader.readAsText(file); });
      // Primer render
      UI.render();
    })();
  </script>

  <!-- Gu√≠a JSON para hojalater√≠a (importaci√≥n masiva)
  [
    {
      "brand":"Ford","model":"Bronco Sport","year":2024,"market":"US",
      "panel":"Puerta delantera","side":"LH","material":"Acero",
      "thickness_mm":0.8, "tolerance_mm":0.3, "repair_zone":"Zona A",
      "length_mm":4387, "width_mm":1887, "height_mm":1783, "wheelbase_mm":2670,
      "curb_kg":1640, "labor_body_hr":2.5, "labor_refinish_hr":1.6,
      "adhesive":"Epoxi", "seam_sealer":"PU", "fasteners":"Clips",
      "torque_nm":7, "paint_code":"YZ", "blend_required":true,
      "oem_proc_url":"https://oem.example/ford/bronco/2024/door", "notes":"Quitar moldura A" 
    }
  ]
  Alias aceptados: marca/make, modelo/name, ano/year, mercado/market; *_in (pulgadas) y curb_lb (libras) se convierten a mm/kg.
  -->
</body>
</html>
