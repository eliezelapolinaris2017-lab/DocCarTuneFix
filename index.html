<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Doctor Car Pro — Estimador Carrocería PR</title>
<style>
:root{
  --bg:#0f1115; --card:#171922; --muted:#a8b0c0; --fg:#ffffff; --accent:#ef4444; --accent2:#3b82f6; --ok:#10b981; --warn:#f59e0b;
  --border:#23263a; --chip:#0e1018; --ink:#0b0c10; --table:#0c0e14; --print-bg:#ffffff; --print-fg:#111827;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.2));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.container{max-width:1200px;margin:0 auto;padding:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.logo{height:42px;width:42px;border-radius:10px;object-fit:cover;background:#111;border:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{font-size:18px;margin:0}
nav{display:flex;gap:8px;flex-wrap:wrap}
nav button{background:#121421;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
nav button.active{background:var(--accent);border-color:#000}
.badge{display:inline-block;background:#151826;border:1px dashed var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
hr.sep{border:none;border-top:1px solid var(--border);margin:12px 0}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0d0f18;color:var(--fg)}
input[type="color"]{padding:2px;height:40px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#121421;color:var(--fg);cursor:pointer}
.btn.primary{background:var(--accent);border-color:#000;color:#fff}
.btn.alt{background:var(--accent2)}
.btn.ok{background:var(--ok);color:#08110c}
.btn.warn{background:var(--warn)}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
.table thead th{position:sticky;top:68px;background:#0d0f18;z-index:1}
.table tr:hover td{background:#0d0f1811}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e111a;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
.right{display:flex;justify-content:flex-end}
.center{text-align:center}
footer{color:var(--muted);font-size:12px;padding:24px}
/* Print */
@media print{
  body{background:var(--print-bg);color:var(--print-fg)}
  header, #tabs, #loginView, .no-print{display:none!important}
  .card{border:none;box-shadow:none;padding:0}
  .printable{display:block}
  .quote{border:1px solid #d1d5db;border-radius:12px;padding:16px}
}
/* ====== Estilo para vista tipo Mitchell (árbol + diagrama + lista) ====== */
.split{display:grid;grid-template-columns:260px 1fr 340px;gap:12px;}
.tree{background:#0d0f18;border:1px solid var(--border);border-radius:12px;padding:8px;max-height:520px;overflow:auto}
.tree details{border-left:2px solid #1f2333;margin:2px 0;padding-left:6px}
.tree summary{cursor:pointer;color:#c7cee0}
.diagram{background:#0d0f18;border:1px solid var(--border);border-radius:12px;min-height:420px;position:relative;display:flex;align-items:center;justify-content:center}
.diagram svg{max-width:100%;height:auto;opacity:.95}
.hotspot{position:absolute;display:flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:999px;background:var(--accent);color:#fff;font-weight:700;border:1px solid #000;cursor:pointer}
.partsList{background:#0d0f18;border:1px solid var(--border);border-radius:12px;padding:8px;max-height:520px;overflow:auto}
.partsList .row{justify-content:space-between}
.partsList .item{border-bottom:1px dashed var(--border);padding:6px 0}
</style>
</head>
<body>
<header>
  <div class="container row" style="align-items:center;justify-content:space-between">
    <div class="brand">
      <img id="logoImg" class="logo" alt="logo"/>
      <h1>Doctor Car Pro — Estimador Carrocería PR</h1>
      <span class="badge">Mitchell-style · Local/JSON · Offline</span>
    </div>
    <div class="row">
      <button class="btn" id="btnImport">Importar JSON</button>
      <button class="btn" id="btnExport">Exportar JSON</button>
      <button class="btn ok" id="btnSave">Guardar</button>
      <button class="btn alt" id="btnPrint">Imprimir</button>
      <button class="btn" id="btnLogout">Salir</button>
    </div>
  </div>
</header>

<div class="container" id="loginView">
  <div class="card" style="max-width:520px;margin:24px auto">
    <h2 style="margin:0 0 6px">Iniciar sesión</h2>
    <p class="small">Credenciales iniciales: <span class="kbd">admin</span> / <span class="kbd">admin123</span> (cámbialas en Configuración)</p>
    <div class="grid cols-1">
      <div>
        <label>Usuario</label>
        <input id="lgUser" placeholder="usuario" autocomplete="username"/>
      </div>
      <div>
        <label>Contraseña</label>
        <input id="lgPass" type="password" placeholder="********" autocomplete="current-password"/>
      </div>
      <div class="right">
        <button class="btn primary" id="doLogin">Entrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container" id="app" class="hidden">
  <div id="tabs" class="row no-print" style="margin:16px 0">
    <nav>
      <button data-tab="estimados" class="active">Estimados</button>
      <button data-tab="clientes">Clientes</button>
      <button data-tab="base">Base de Datos</button>
      <button data-tab="config">Configuración</button>
      <button data-tab="ayuda">Ayuda</button>
    </nav>
  </div>

  <!-- Estimados -->
  <section id="tab-estimados" class="card">
    <div class="grid cols-3">
      <div>
        <label>Cliente</label>
        <input id="qCliente" placeholder="Nombre del cliente"/>
      </div>
      <div>
        <label>Teléfono</label>
        <input id="qTel" placeholder="787-000-0000"/>
      </div>
      <div>
        <label>Email</label>
        <input id="qEmail" placeholder="cliente@email.com"/>
      </div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div>
        <label>Marca</label>
        <select id="qMake"></select>
      </div>
      <div>
        <label>Modelo</label>
        <select id="qModel"></select>
      </div>
      <div>
        <label>Año</label>
        <select id="qYear"></select>
      </div>
      <div>
        <label>VIN (opcional)</label>
        <input id="qVIN" placeholder="17 chars"/>
      </div>
    </div>

    <hr class="sep"/>

    <div class="no-print" style="margin:6px 0 12px;display:flex;gap:8px;align-items:center">
      <button class="btn primary" id="addLine">Añadir partida</button>
      <input id="quickPart" placeholder="Buscar pieza (ej: bumper, tapalodo, bonete)" style="max-width:320px"/>
      <span class="badge">o usa la vista por diagrama ↓</span>
    </div>

    <!-- ===== Vista tipo Mitchell: Árbol + Diagrama + Lista ===== -->
    <div class="split no-print" id="explodedView">
      <!-- Árbol de secciones -->
      <div class="tree" id="tree"></div>

      <!-- Diagrama con hotspots -->
      <div class="diagram" id="diagram">
        <!-- SVG simple de un sedán lado izquierdo -->
        <svg viewBox="0 0 600 260" aria-label="diagrama-carro">
          <defs>
            <linearGradient id="carPaint" x1="0" x2="1">
              <stop offset="0%" stop-color="#1f2a44"/>
              <stop offset="100%" stop-color="#2a375c"/>
            </linearGradient>
          </defs>
          <g>
            <rect x="40" y="120" width="520" height="60" rx="14" fill="url(#carPaint)" stroke="#4b5563"/>
            <path d="M80 120 C140 50, 240 40, 360 70 L520 120 Z" fill="url(#carPaint)" stroke="#4b5563"/>
            <circle cx="160" cy="190" r="36" fill="#0b0d14" stroke="#6b7280"/>
            <circle cx="440" cy="190" r="36" fill="#0b0d14" stroke="#6b7280"/>
            <rect x="210" y="105" width="110" height="35" rx="6" fill="#111827" stroke="#6b7280"/>
          </g>
        </svg>
        <!-- Hotspots posicionados con JS -->
      </div>

      <!-- Lista de piezas filtradas por sección -->
      <div class="partsList" id="partsList">
        <div class="row" style="align-items:center"><strong>Piezas</strong><span class="small" id="partsHint">Filtra desde el árbol o pulsa en un número</span></div>
        <div id="partsItems"></div>
      </div>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table class="table" id="linesTbl">
        <thead>
          <tr>
            <th style="min-width:160px">Pieza / Descripción</th>
            <th>Tipo</th>
            <th>Cant.</th>
            <th>Precio unit.</th>
            <th>Horas carrocería</th>
            <th>Horas pintura</th>
            <th>Subtotal</th>
            <th class="no-print"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="grid cols-3" style="margin-top:12px">
      <div class="card">
        <h3 style="margin:0 0 8px">Totales</h3>
        <div class="grid cols-2">
          <div><label>Partes</label><div id="tParts" class="kbd">$0.00</div></div>
          <div><label>Labor carrocería</label><div id="tLaborBody" class="kbd">$0.00</div></div>
          <div><label>Labor pintura</label><div id="tLaborPaint" class="kbd">$0.00</div></div>
          <div><label>Materiales pintura</label><div id="tMaterials" class="kbd">$0.00</div></div>
          <div><label>Comisiones/Fees</label><div id="tFees" class="kbd">$0.00</div></div>
          <div><label>Subtotal</label><div id="tSub" class="kbd">$0.00</div></div>
          <div><label>IVU</label><div id="tTax" class="kbd">$0.00</div></div>
          <div><label>Total</label><div id="tTotal" class="kbd">$0.00</div></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Observaciones</h3>
        <textarea id="qNotes" rows="6" placeholder="Notas técnicas, códigos de color, blend, alineación, calibraciones ADAS, etc."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" id="saveQuote">Guardar Estimado</button>
          <button class="btn alt" id="printQuote">Imprimir Cotización</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Tarifas activas</h3>
        <div class="grid cols-2">
          <div><label>$/h carrocería</label><input id="rateBody" type="number" step="0.01"/></div>
          <div><label>$/h pintura</label><input id="ratePaint" type="number" step="0.01"/></div>
          <div><label>Materiales %</label><input id="materialsPct" type="number" step="0.1"/></div>
          <div><label>Comisiones/Fees %</label><input id="feesPct" type="number" step="0.1"/></div>
          <div><label>IVU %</label><input id="taxPct" type="number" step="0.01"/></div>
        </div>
      </div>
    </div>

    <div id="printArea" class="printable" style="display:none">...</div>
  </section>

  <!-- Clientes -->
  <section id="tab-clientes" class="card hidden">
  <section id="tab-clientes" class="card hidden">
    <div class="row">
      <input id="cSearch" placeholder="Buscar cliente" style="max-width:320px"/>
      <button class="btn" id="cNew">Nuevo</button>
    </div>
    <table class="table" id="cTbl">
      <thead><tr><th>Nombre</th><th>Teléfono</th><th>Email</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Base de Datos -->
  <section id="tab-base" class="card hidden">
    <div class="row">
      <button class="btn" id="addVehicle">Añadir Vehículo</button>
      <button class="btn" id="addPart">Añadir Pieza</button>
      <span class="badge">Editable · Importa/Exporta JSON</span>
    </div>
    <div class="grid cols-3" style="margin-top:8px">
      <div>
        <label>Marca</label>
        <select id="dbMake"></select>
      </div>
      <div>
        <label>Modelo</label>
        <select id="dbModel"></select>
      </div>
      <div>
        <label>Año</label>
        <select id="dbYear"></select>
      </div>
    </div>
    <table class="table" id="partsTbl" style="margin-top:8px">
      <thead><tr><th>Pieza</th><th>Tipo</th><th>Condición</th><th>Precio</th><th>HrsBody</th><th>HrsPaint</th><th>Proveedor</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Configuración -->
  <section id="tab-config" class="card hidden">
    <div class="grid cols-3">
      <div>
        <h3>Empresa</h3>
        <label>Nombre comercial</label>
        <input id="cfgName" placeholder="Tu taller"/>
        <label>Teléfono</label>
        <input id="cfgPhone" placeholder="787-..."/>
        <label>Email</label>
        <input id="cfgMail" placeholder="correo@dominio.com"/>
        <label>Dirección</label>
        <textarea id="cfgAddr" rows="3" placeholder="Dirección"></textarea>
        <label>Logo (PNG/JPG)</label>
        <input id="cfgLogo" type="file" accept="image/*"/>
      </div>
      <div>
        <h3>Tarifas & Impuestos</h3>
        <label>Carrocería $/h</label>
        <input id="cfgRateBody" type="number" step="0.01"/>
        <label>Pintura $/h</label>
        <input id="cfgRatePaint" type="number" step="0.01"/>
        <label>Materiales %</label>
        <input id="cfgMaterialsPct" type="number" step="0.1"/>
        <label>Comisiones/Fees %</label>
        <input id="cfgFeesPct" type="number" step="0.1"/>
        <label>IVU % (PR)</label>
        <input id="cfgTaxPct" type="number" step="0.01"/>
        <label>Moneda</label>
        <select id="cfgCurrency"><option value="USD">USD</option><option value="USD">USD</option></select>
      </div>
      <div>
        <h3>Estilo</h3>
        <label>Color primario</label>
        <input id="cAccent" type="color"/>
        <label>Color secundario</label>
        <input id="cAccent2" type="color"/>
        <label>Fondo</label>
        <input id="cBg" type="color"/>
        <label>Texto</label>
        <input id="cFg" type="color"/>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" id="applyTheme">Aplicar</button>
          <button class="btn" id="resetTheme">Reset</button>
        </div>
        <hr class="sep"/>
        <h3>Usuarios</h3>
        <label>Usuario</label>
        <input id="newUser" placeholder="nuevo usuario"/>
        <label>Contraseña</label>
        <input id="newPass" type="password" placeholder="********"/>
        <div class="row" style="margin-top:8px"><button class="btn" id="addUser">Guardar/Actualizar</button></div>
        <p class="small">Admin inicial: admin / admin123</p>
      </div>
    </div>
  </section>

  <!-- Ayuda -->
  <section id="tab-ayuda" class="card hidden">
    <h3>Cómo usar</h3>
    <ul>
      <li>Importa tu catálogo JSON (piezas por marca/modelo/año). Puedes ampliar y exportar.</li>
      <li>En Configuración define tarifas ($/h), IVU (PR 11.5% por defecto), materiales y comisiones.</li>
      <li>En Estimados selecciona vehículo y añade partidas desde tu catálogo o escribe manual.</li>
      <li>Imprime con el botón “Imprimir Cotización” (usa PDF en el diálogo del navegador).</li>
      <li>Todo queda guardado en este dispositivo (LocalStorage). No hay servidor.</li>
    </ul>
  </section>
</div>

<footer class="center small no-print">© <span id="y"></span> Doctor Car Pro · Estimador Carrocería PR — Hecho para Puerto Rico. Datos locales editables. </footer>

<script>
// ============================
// UTILIDADES
// ============================
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = (n, cur) => (new Intl.NumberFormat('es-PR',{style:'currency',currency:cur||state.cfg.currency}).format(+n||0));
const id = ()=>'id_'+Math.random().toString(36).slice(2,9);
function download(filename, text){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'application/json'}));
  a.download=filename; a.click();
}
function toDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});}

// ============================
// ESTADO + SEED JSON (editable)
// ============================
const SEED = {
  meta:{name:'Doctor Car Pro — Estimador PR', version:'1.0.0', currency:'USD', default_ivu:11.5, created: new Date().toISOString()},
  cfg:{
    business:{name:'Tu Taller', phone:'787-000-0000', email:'taller@correo.com', addr:'Dirección, PR', logo:null},
    rates:{body:65, paint:60, materialsPct:8, feesPct:2, taxPct:11.5},
    theme:{bg:'#0f1115', fg:'#ffffff', accent:'#ef4444', accent2:'#3b82f6'},
    users:[{u:'admin', p:'admin123', role:'admin'}],
    currency:'USD'
  },
  vehicles:[
    {make:'Toyota', models:[{name:'Corolla', years:[2014,2015,2016,2017,2018]},{name:'RAV4', years:[2016,2017,2018,2019]}]},
    {make:'Honda', models:[{name:'Civic', years:[2012,2013,2014,2015]},{name:'CR-V', years:[2015,2016,2017]}]},
    {make:'Nissan', models:[{name:'Sentra', years:[2013,2014,2015,2016]},{name:'Altima', years:[2014,2015,2016]}]},
    {make:'Hyundai', models:[{name:'Elantra', years:[2016,2017,2018]},{name:'Tucson', years:[2016,2017,2018]}]},
    {make:'Kia', models:[{name:'Rio', years:[2016,2017,2018]},{name:'Sportage', years:[2016,2017,2018]}]},
    {make:'Ford', models:[{name:'Focus', years:[2014,2015,2016]},{name:'Escape', years:[2015,2016,2017]}]},
    {make:'Chevrolet', models:[{name:'Malibu', years:[2015,2016,2017]},{name:'Equinox', years:[2016,2017,2018]}]},
    {make:'Jeep', models:[{name:'Wrangler', years:[2012,2013,2014,2015]},{name:'Cherokee', years:[2015,2016,2017]}]},
    {make:'Mitsubishi', models:[{name:'Lancer', years:[2014,2015,2016]},{name:'Outlander', years:[2015,2016,2017]}]}
  ],
  // Catálogo mínimo demostrativo. Amplíalo con Importar/Exportar.
  parts:[
    // Toyota Corolla 2016 ejemplos
    {make:'Toyota', model:'Corolla', year:2016, name:'Bumper delantero', type:'Parte', condition:'Aftermarket', price:240, hrsBody:2.0, hrsPaint:1.5, vendor:'Local aftermarket'},
    {make:'Toyota', model:'Corolla', year:2016, name:'Tapalodo izq.', type:'Parte', condition:'OEM', price:220, hrsBody:1.8, hrsPaint:1.2, vendor:'Dealer PR'},
    {make:'Toyota', model:'Corolla', year:2016, name:'Bonete (hood)', type:'Parte', condition:'Reciclada', price:180, hrsBody:2.5, hrsPaint:2.0, vendor:'Junker PR'},
    {make:'Toyota', model:'Corolla', year:2016, name:'Farol izq.', type:'Parte', condition:'Aftermarket', price:130, hrsBody:0.8, hrsPaint:0.0, vendor:'Local aftermarket'},
    {make:'Toyota', model:'Corolla', year:2016, name:'Pintura color base', type:'Material', condition:'-', price:0, hrsBody:0, hrsPaint:1.0, vendor:'-'},

    // Honda Civic 2014
    {make:'Honda', model:'Civic', year:2014, name:'Bumper trasero', type:'Parte', condition:'Aftermarket', price:230, hrsBody:1.6, hrsPaint:1.4, vendor:'Local aftermarket'},
    {make:'Honda', model:'Civic', year:2014, name:'Puerta delantera der.', type:'Parte', condition:'OEM', price:520, hrsBody:3.0, hrsPaint:2.0, vendor:'Dealer PR'},

    // Nissan Sentra 2015
    {make:'Nissan', model:'Sentra', year:2015, name:'Baúl (trunk lid)', type:'Parte', condition:'Reciclada', price:250, hrsBody:2.2, hrsPaint:1.8, vendor:'Junker PR'},

    // Algunos genéricos por si el año no aparece
    {make:'*', model:'*', year:'*', name:'Aro 16"', type:'Parte', condition:'Aftermarket', price:120, hrsBody:0.3, hrsPaint:0.0, vendor:'Local ruedas'},
    {make:'*', model:'*', year:'*', name:'Barreta / Parrilla', type:'Parte', condition:'Aftermarket', price:160, hrsBody:0.7, hrsPaint:0.5, vendor:'Local aftermarket'}
  ],
  clients:[],
  quotes:[]
};

let state = JSON.parse(localStorage.getItem('dcp_state')||'null') || {cfg:SEED.cfg, db:{vehicles:SEED.vehicles, parts:SEED.parts, clients:SEED.clients}, quotes:[], session:null};

function persist(){localStorage.setItem('dcp_state', JSON.stringify(state));}

// ============================
// AUTH
// ============================
function showApp(logged){
  $('#loginView').style.display = logged? 'none':'block';
  $('#app').style.display = logged? 'block':'none';
}
$('#doLogin').onclick = ()=>{
  const u=$('#lgUser').value.trim();
  const p=$('#lgPass').value;
  const ok = state.cfg.users?.some(x=>x.u===u && x.p===p);
  if(ok){ state.session={u, ts:Date.now()}; persist(); showApp(true); initUI(); }
  else alert('Usuario/contraseña inválidos');
};
$('#btnLogout').onclick=()=>{state.session=null; persist(); showApp(false)};

// ============================
// NAV TABS
// ============================
$$('nav button').forEach(b=>b.onclick=()=>{
  $$('nav button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const tab=b.dataset.tab; 
  ['estimados','clientes','base','config','ayuda'].forEach(t=>{
    $('#tab-'+t).classList.toggle('hidden', t!==tab);
  });
});

// ============================
// CONFIG / THEME / USERS
// ============================
function loadCfgForm(){
  const c=state.cfg;
  $('#cfgName').value=c.business.name; $('#cfgPhone').value=c.business.phone; $('#cfgMail').value=c.business.email; $('#cfgAddr').value=c.business.addr;
  $('#cfgRateBody').value=c.rates.body; $('#cfgRatePaint').value=c.rates.paint; $('#cfgMaterialsPct').value=c.rates.materialsPct; $('#cfgFeesPct').value=c.rates.feesPct; $('#cfgTaxPct').value=c.rates.taxPct; 
  $('#cfgCurrency').value=c.currency;
  $('#cAccent').value=c.theme.accent; $('#cAccent2').value=c.theme.accent2; $('#cBg').value=c.theme.bg; $('#cFg').value=c.theme.fg;
  if(c.business.logo) $('#logoImg').src = c.business.logo; else $('#logoImg').src='';
}
$('#applyTheme').onclick=()=>{
  const th=state.cfg.theme={bg:$('#cBg').value, fg:$('#cFg').value, accent:$('#cAccent').value, accent2:$('#cAccent2').value};
  document.documentElement.style.setProperty('--bg', th.bg);
  document.documentElement.style.setProperty('--fg', th.fg);
  document.documentElement.style.setProperty('--accent', th.accent);
  document.documentElement.style.setProperty('--accent2', th.accent2);
  persist();
};
$('#resetTheme').onclick=()=>{state.cfg.theme=SEED.cfg.theme; loadCfgForm(); $('#applyTheme').click();}
$('#cfgLogo').onchange=async(e)=>{ const f=e.target.files?.[0]; if(!f) return; state.cfg.business.logo = await toDataURL(f); persist(); loadCfgForm(); };
$('#addUser').onclick=()=>{
  const u=$('#newUser').value.trim(); const p=$('#newPass').value.trim(); if(!u||!p) return alert('Completa usuario y contraseña');
  const i=state.cfg.users.findIndex(x=>x.u===u); if(i>=0) state.cfg.users[i].p=p; else state.cfg.users.push({u,p,role:'admin'});
  persist(); alert('Usuario guardado');
};

// ============================
// VEHÍCULOS SELECTORES (Estimados + DB)
// ============================
function fillSelectors(prefix){
  const mk=$('#'+prefix+'Make'), md=$('#'+prefix+'Model'), yr=$('#'+prefix+'Year');
  mk.innerHTML = state.db.vehicles.map(v=>`<option value="${v.make}">${v.make}</option>`).join('');
  mk.onchange=()=>{ const v=state.db.vehicles.find(x=>x.make===mk.value); md.innerHTML=(v?.models||[]).map(m=>`<option value="${m.name}">${m.name}</option>`).join(''); md.onchange(); };
  md.onchange=()=>{ const v=state.db.vehicles.find(x=>x.make===mk.value); const m=v?.models.find(x=>x.name===md.value); yr.innerHTML=(m?.years||[]).map(y=>`<option>${y}</option>`).join(''); };
  mk.onchange();
}

// ============================
// LÍNEAS DE ESTIMADO
// ============================
const lines=[];
function renderLines(){
  const tb=$('#linesTbl tbody'); tb.innerHTML='';
  const rateB=+$('#rateBody').value, rateP=+$('#ratePaint').value;
  let parts=0, lb=0, lp=0;
  lines.forEach((ln,i)=>{
    const imp = (ln.qty*ln.price) + (ln.hrsBody*rateB) + (ln.hrsPaint*rateP);
    parts += (ln.qty*ln.price); lb += ln.hrsBody*rateB; lp += ln.hrsPaint*rateP;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${ln.name}" data-k="name"/></td>
      <td><select data-k="type"><option ${ln.type==='Parte'?'selected':''}>Parte</option><option ${ln.type==='Labor'?'selected':''}>Labor</option><option ${ln.type==='Material'?'selected':''}>Material</option></select></td>
      <td><input type="number" step="0.01" value="${ln.qty}" data-k="qty"/></td>
      <td><input type="number" step="0.01" value="${ln.price}" data-k="price"/></td>
      <td><input type="number" step="0.1" value="${ln.hrsBody}" data-k="hrsBody"/></td>
      <td><input type="number" step="0.1" value="${ln.hrsPaint}" data-k="hrsPaint"/></td>
      <td align="right">${fmt(imp)}</td>
      <td class="no-print"><button class="btn" data-rm="${i}">✕</button></td>`;
    tb.appendChild(tr);
  });
  const materialsPct=+$('#materialsPct').value/100; const feesPct=+$('#feesPct').value/100; const taxPct=+$('#taxPct').value/100;
  const materials = (lb+lp)*materialsPct; const fees=(parts+lb+lp+materials)*feesPct; const sub=parts+lb+lp+materials+fees; const tax=sub*taxPct; const tot=sub+tax;
  $('#tParts').textContent=fmt(parts); $('#tLaborBody').textContent=fmt(lb); $('#tLaborPaint').textContent=fmt(lp);
  $('#tMaterials').textContent=fmt(materials); $('#tFees').textContent=fmt(fees); $('#tSub').textContent=fmt(sub); $('#tTax').textContent=fmt(tax); $('#tTotal').textContent=fmt(tot);

  // imprimir
  $('#pParts').textContent=fmt(parts); $('#pLaborBody').textContent=fmt(lb); $('#pLaborPaint').textContent=fmt(lp);
  $('#pMaterials').textContent=fmt(materials); $('#pFees').textContent=fmt(fees); $('#pSub').textContent=fmt(sub); $('#pTax').textContent=fmt(tax); $('#pTotal').textContent=fmt(tot);
}

$('#linesTbl').addEventListener('input', (e)=>{
  const inp=e.target; const tr=inp.closest('tr'); const idx=[...tr.parentNode.children].indexOf(tr);
  const k=inp.dataset.k; if(k) lines[idx][k] = (k==='name'||k==='type')? inp.value : +inp.value; renderLines();
});
$('#linesTbl').addEventListener('click', (e)=>{ const rm=e.target.dataset.rm; if(rm!==undefined){ lines.splice(+rm,1); renderLines(); }});

$('#addLine').onclick=()=>{ lines.push({name:'(descripción)', type:'Parte', qty:1, price:0, hrsBody:0, hrsPaint:0}); renderLines(); };
$('#quickPart').addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    const t=e.target.value.toLowerCase();
    const mk=$('#qMake').value, md=$('#qModel').value, yr=$('#qYear').value;
    const found = state.db.parts.find(p=> (p.make===mk||p.make==='*') && (p.model===md||p.model==='*') && (p.year==yr||p.year==='*') && p.name.toLowerCase().includes(t));
    if(found){ lines.push({name:found.name, type:found.type, qty:1, price:found.price, hrsBody:found.hrsBody, hrsPaint:found.hrsPaint}); renderLines(); }
    else{ alert('No se encontró en catálogo. Se añadirá en blanco.'); lines.push({name:e.target.value, type:'Parte', qty:1, price:0, hrsBody:0, hrsPaint:0}); renderLines(); }
    e.target.value='';
  }
});

// ============================
// TOTALES EN TIEMPO REAL (desde tarjetas de la derecha)
// ============================
['rateBody','ratePaint','materialsPct','feesPct','taxPct'].forEach(idv=>{ $('#'+idv).addEventListener('input', renderLines) });

// ============================
// CLIENTES
// ============================
function renderClients(){
  const q=$('#cSearch').value?.toLowerCase()||''; const tb=$('#cTbl tbody'); tb.innerHTML='';
  state.db.clients.filter(c=>!q||c.name.toLowerCase().includes(q)).forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${c.phone||''}</td><td>${c.email||''}</td><td><button class='btn' data-ed='${i}'>Editar</button> <button class='btn' data-del='${i}'>Borrar</button></td>`; tb.appendChild(tr);
  });
}
$('#cSearch').oninput=renderClients;
$('#cNew').onclick=()=>{
  const name=prompt('Nombre del cliente'); if(!name) return; const phone=prompt('Teléfono'); const email=prompt('Email');
  state.db.clients.push({id:id(), name, phone, email}); persist(); renderClients();
};
$('#cTbl').onclick=(e)=>{
  const ed=e.target.dataset.ed, del=e.target.dataset.del; if(ed){
    const c=state.db.clients[+ed]; const name=prompt('Nombre', c.name)||c.name; const phone=prompt('Teléfono', c.phone||'')||c.phone; const email=prompt('Email', c.email||'')||c.email; Object.assign(c,{name,phone,email}); persist(); renderClients();
  }else if(del){ if(confirm('¿Borrar cliente?')){ state.db.clients.splice(+del,1); persist(); renderClients(); } }
};

// ============================
// BASE DE DATOS (Piezas)
// ============================
function syncDBSelectors(){ fillSelectors('db'); }
function renderParts(){
  const mk=$('#dbMake').value, md=$('#dbModel').value, yr=$('#dbYear').value; const tb=$('#partsTbl tbody'); tb.innerHTML='';
  state.db.parts.filter(p=> (p.make===mk||p.make==='*') && (p.model===md||p.model==='*') && (p.year==yr||p.year==='*')).forEach((p,i)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td><input value="${p.name}" data-k="name"/></td>
      <td><input value="${p.type}" data-k="type"/></td>
      <td><input value="${p.condition}" data-k="condition"/></td>
      <td><input type='number' step='0.01' value='${p.price}' data-k='price'/></td>
      <td><input type='number' step='0.1' value='${p.hrsBody}' data-k='hrsBody'/></td>
      <td><input type='number' step='0.1' value='${p.hrsPaint}' data-k='hrsPaint'/></td>
      <td><input value='${p.vendor||''}' data-k='vendor'/></td>
      <td><button class='btn' data-del='${p._id||''}'>✕</button></td>`;
    tr.dataset.pid = p._id; tb.appendChild(tr);
  });
}
$('#partsTbl').addEventListener('input',(e)=>{
  const tr=e.target.closest('tr'); const pid=tr.dataset.pid; const p=state.db.parts.find(x=>x._id===pid); const k=e.target.dataset.k; p[k] = (k==='name'||k==='type'||k==='condition'||k==='vendor')? e.target.value : +e.target.value; persist();
});
$('#partsTbl').addEventListener('click',(e)=>{ if(e.target.dataset.del){ const pid=e.target.closest('tr').dataset.pid; const i=state.db.parts.findIndex(x=>x._id===pid); if(i>=0){ state.db.parts.splice(i,1); persist(); renderParts(); } }});
$('#addVehicle').onclick=()=>{
  const make=prompt('Marca (ej. Toyota)'); if(!make) return;
  let m = state.db.vehicles.find(v=>v.make===make); if(!m){ m={make, models:[]}; state.db.vehicles.push(m); }
  const model=prompt('Modelo (ej. Corolla)'); if(!model) return;
  let md=m.models.find(x=>x.name===model); if(!md){ md={name:model, years:[]}; m.models.push(md); }
  const year=parseInt(prompt('Año (ej. 2016)'),10); if(year){ if(!md.years.includes(year)) md.years.push(year); }
  persist(); syncDBSelectors(); renderParts(); alert('Vehículo añadido');
};
$('#addPart').onclick=()=>{
  const mk=$('#dbMake').value, md=$('#dbModel').value, yr=$('#dbYear').value; 
  const name=prompt('Nombre pieza (ej. Bumper delantero)'); if(!name) return;
  const price=parseFloat(prompt('Precio sugerido', '0'))||0; const hrsB=parseFloat(prompt('Horas carrocería','0'))||0; const hrsP=parseFloat(prompt('Horas pintura','0'))||0;
  const p={_id:id(), make:mk, model:md, year:+yr, name, type:'Parte', condition:'Aftermarket', price, hrsBody:hrsB, hrsPaint:hrsP, vendor:'Local'};
  state.db.parts.push(p); persist(); renderParts();
};

// ============================
// ESTIMADO -> GUARDAR/IMPRIMIR
// ============================
function refreshRatesBox(){
  $('#rateBody').value=state.cfg.rates.body; $('#ratePaint').value=state.cfg.rates.paint; $('#materialsPct').value=state.cfg.rates.materialsPct; $('#feesPct').value=state.cfg.rates.feesPct; $('#taxPct').value=state.cfg.rates.taxPct;
}
function printCurrent(){
  // Compactar datos en área de impresión
  $('#pLogo').src = state.cfg.business.logo||'';
  $('#pCliente').textContent=$('#qCliente').value; $('#pTel').textContent=$('#qTel').value; $('#pEmail').textContent=$('#qEmail').value;
  $('#pVehicle').textContent = `${$('#qYear').value} ${$('#qMake').value} ${$('#qModel').value}`; $('#pVIN').textContent=$('#qVIN').value? `VIN: ${$('#qVIN').value}`:'';
  const tb=$('#pLines'); tb.innerHTML='';
  const rateB=+$('#rateBody').value, rateP=+$('#ratePaint').value;
  lines.forEach(ln=>{
    const imp = (ln.qty*ln.price) + (ln.hrsBody*rateB) + (ln.hrsPaint*rateP);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ln.name}</td><td>${ln.type}</td><td align='right'>${ln.qty}</td><td align='right'>${fmt(ln.price)}</td><td align='right'>${(ln.hrsBody+ln.hrsPaint).toFixed(1)}</td><td align='right'>${fmt(imp)}</td>`; tb.appendChild(tr);
  });
  window.print();
}
$('#printQuote').onclick=printCurrent; $('#btnPrint').onclick=printCurrent;

$('#saveQuote').onclick=()=>{
  const q={
    id:id(), ts:new Date().toISOString(),
    customer:{name:$('#qCliente').value, phone:$('#qTel').value, email:$('#qEmail').value},
    vehicle:{make:$('#qMake').value, model:$('#qModel').value, year:$('#qYear').value, vin:$('#qVIN').value},
    rates:{body:+$('#rateBody').value, paint:+$('#ratePaint').value, materials:+$('#materialsPct').value, fees:+$('#feesPct').value, tax:+$('#taxPct').value},
    lines:JSON.parse(JSON.stringify(lines))
  };
  state.quotes.push(q); persist(); alert('Estimado guardado');
};

// ============================
// IMPORT / EXPORT / SAVE
// ============================
$('#btnExport').onclick=()=>{
  const out={meta:SEED.meta, cfg:state.cfg, db:state.db, quotes:state.quotes};
  download('doctor-car-pro_estimator.json', JSON.stringify(out,null,2));
};
$('#btnImport').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=async()=>{
    const f=i.files?.[0]; if(!f) return; const txt=await f.text();
    try{ const j=JSON.parse(txt); if(j.cfg) state.cfg=j.cfg; if(j.db) state.db=j.db; if(j.quotes) state.quotes=j.quotes; persist(); initUI(); alert('Importado correctamente'); }
    catch(e){ alert('JSON inválido'); }
  }; i.click();
};
$('#btnSave').onclick=()=>{ persist(); alert('Guardado'); };

// ============================
// VISTA TIPO MITCHELL (ÁRBOL, DIAGRAMA, LISTA)
// ============================
const DIAGRAM_MAP = [
  {n:1, key:'Bumper delantero', x:350, y:140},
  {n:2, key:'Bonete', x:280, y:90},
  {n:3, key:'Tapalodo izq', x:120, y:130},
  {n:4, key:'Tapalodo der', x:470, y:130},
  {n:5, key:'Puerta delantera der', x:420, y:150},
  {n:6, key:'Bumper trasero', x:520, y:160},
  {n:7, key:'Baúl', x:500, y:110}
];
function buildTree(){
  const cont = $('#tree'); cont.innerHTML='';
  const mk=$('#qMake').value, md=$('#qModel').value, yr=$('#qYear').value;
  const list = state.db.parts.filter(p=> (p.make===mk||p.make==='*') && (p.model===md||p.model==='*') && (p.year==yr||p.year==='*'));
  const groups = {};
  list.forEach(p=>{ const sec = (p.type==='Parte'?'Partes':p.type==='Labor'?'Labor':'Materiales'); (groups[sec]||(groups[sec]=[])).push(p); });
  Object.entries(groups).forEach(([sec, arr])=>{
    const det=document.createElement('details'); det.open=true;
    det.innerHTML=`<summary>${sec} <span class='small'>(${arr.length})</span></summary>`;
    arr.forEach(p=>{
      const a=document.createElement('div'); a.className='item'; a.style.cursor='pointer'; a.textContent=p.name + (p.condition?` · ${p.condition}`:'');
      a.onclick=()=> addFromCatalog(p);
      det.appendChild(a);
    });
    cont.appendChild(det);
  });
}
function renderHotspots(){
  const box = $('#diagram'); $$('.hotspot').forEach(h=>h.remove());
  DIAGRAM_MAP.forEach(h=>{
    const el=document.createElement('div'); el.className='hotspot'; el.style.left = (h.x-12)+'px'; el.style.top=(h.y-12)+'px'; el.textContent=h.n;
    el.title = h.key; el.onclick=()=> addByKey(h.key);
    box.appendChild(el);
  });
}
function renderPartsList(){
  const mk=$('#qMake').value, md=$('#qModel').value, yr=$('#qYear').value;
  const items=$('#partsItems'); items.innerHTML='';
  const list = state.db.parts.filter(p=> (p.make===mk||p.make==='*') && (p.model===md||p.model==='*') && (p.year==yr||p.year==='*'));
  list.forEach(p=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div class='row'><span>${p.name} ${p.condition?`<span class='small'>(${p.condition})</span>`:''}</span><span class='small'>${fmt(p.price)}</span></div>
    <div class='small'>Hrs: carrocería ${p.hrsBody||0} · pintura ${p.hrsPaint||0} · proveedor ${p.vendor||'-'}</div>
    <div class='right'><button class='btn' data-add='1'>Añadir</button></div>`;
    d.querySelector('[data-add]')?.addEventListener('click',()=> addFromCatalog(p));
    items.appendChild(d);
  });
}
function addByKey(key){
  const mk=$('#qMake').value, md=$('#qModel').value, yr=$('#qYear').value;
  const p = state.db.parts.find(pp=> (pp.make===mk||pp.make==='*') && (pp.model===md||pp.model==='*') && (pp.year==yr||pp.year==='*') && pp.name.toLowerCase().includes(key.toLowerCase()));
  if(p) addFromCatalog(p); else alert('No hay coincidencias en el catálogo para: '+key);
}
function addFromCatalog(p){
  lines.push({name:p.name, type:p.type||'Parte', qty:1, price:+p.price||0, hrsBody:+p.hrsBody||0, hrsPaint:+p.hrsPaint||0});
  renderLines();
}

// ============================
// INIT
// ============================
function initUI(){
  // theme
  const th=state.cfg.theme; document.documentElement.style.setProperty('--bg', th.bg); document.documentElement.style.setProperty('--fg', th.fg); document.documentElement.style.setProperty('--accent', th.accent); document.documentElement.style.setProperty('--accent2', th.accent2);
  $('#y').textContent=new Date().getFullYear();
  if(state.cfg.business.logo) $('#logoImg').src=state.cfg.business.logo; else $('#logoImg').src='';
  // selectors estimados
  fillSelectors('q');
  // db selectors
  syncDBSelectors();
  // cfg forms
  loadCfgForm(); refreshRatesBox();
  // tables
  renderClients(); renderParts(); renderLines();
  // vista tipo Mitchell
  buildTree(); renderHotspots(); renderPartsList();
  // refrescar cuando cambie vehículo
  ['qMake','qModel','qYear'].forEach(idv=>{ $('#'+idv).addEventListener('change', ()=>{ buildTree(); renderPartsList(); })});
}

// Asegurar IDs en catálogo
state.db.parts = state.db.parts.map(p=>({...p, _id: p._id||id()}));

// Cargar app
if(state.session){ showApp(true); initUI(); } else { showApp(false); }

</script>
</body>
</html>

